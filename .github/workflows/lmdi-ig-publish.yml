name: Generate IG and publish to GitHub Pages

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - 'LMDI/**'

env:
  IG_SHORTNAME: LMDI

jobs:
  publish:
    runs-on: ubuntu-latest
    container: hl7fhir/ig-publisher-base:latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: üñ•Ô∏è Setup Node.js (LTS)
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: üîé Les no-basis-versjon fra sushi-config.yaml
        id: nobasis
        shell: bash
        run: |
          CFG="LMDI/sushi-config.yaml"
          if [ ! -f "$CFG" ]; then
            CFG="sushi-config.yaml"
          fi
          VER=$(grep -E "^[[:space:]]*hl7\.fhir\.no\.basis:" "$CFG" | sed -E 's/.*hl7\.fhir\.no\.basis:[[:space:]]*"?([0-9]+\.[0-9]+\.[0-9]+)"?.*/\1/')
          if [ -z "$VER" ]; then
            echo "Fant ikke no-basis-versjon i $CFG"; exit 1
          fi
          echo "NO_BASIS_VERSION=$VER" >> $GITHUB_ENV
          echo "Oppdaget no-basis versjon: $VER"

      - name: üì¶ Installer FHIR-pakker (core + no-basis snapshot)
        shell: bash
        run: |
          echo "Installer FHIR R4 core (4.0.1)"
          npm --registry https://packages.simplifier.net install hl7.fhir.r4.core@4.0.1

          echo "Last ned no-basis snapshot $NO_BASIS_VERSION"
          curl -L -o hl7.fhir.no.basis-${NO_BASIS_VERSION}-snapshots.tgz \
            https://raw.githubusercontent.com/HL7Norway/resources/main/snapshots/hl7.fhir.no.basis-${NO_BASIS_VERSION}-snapshots.tgz

          echo "npm install snapshot (lokalt)"
          npm install hl7.fhir.no.basis-${NO_BASIS_VERSION}-snapshots.tgz

          echo "Forbered .fhir cache"
          mkdir -p /github/home/.fhir/packages/hl7.fhir.no.basis#${NO_BASIS_VERSION}/package
          cp -r ./node_modules/hl7.fhir.no.basis/* /github/home/.fhir/packages/hl7.fhir.no.basis#${NO_BASIS_VERSION}/package

      - name: üèóÔ∏è Kj√∏r IG Publisher med Sushi
        shell: bash
        run: |
          cd "$IG_SHORTNAME"
          curl -L https://github.com/HL7/fhir-ig-publisher/releases/latest/download/publisher.jar \
            -o ./input-cache/publisher.jar --create-dirs
          npm install -g fsh-sushi
          java -jar ./input-cache/publisher.jar publisher -ig ig.ini
          
      - name: üöÄ Deploy til GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ${{ env.IG_SHORTNAME }}/output
          destination_dir: currentbuild
          commit_message: '${{ env.IG_SHORTNAME }}: ${{ github.event.head_commit.message }}'